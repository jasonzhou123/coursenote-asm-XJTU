# 汇编语言设计
***
其中包括



## 1. 汇编语言发展史
总共分四个阶段：
机器语言、汇编语言、高级语言、混合语言

### 1.1机器语言
最主要的特点就是只包含0和1的代码进行问题的描述。
但是因此会造成很多的麻烦，比如说很难记忆，很难接受。

### 1.2 汇编语言
汇编语言是机器语言符号化的描述，其特点包括：
**引入助记符、用标号和符号来代替地址、引入伪指令以及宏指令**



### 1.3高级语言
### 1.4混和语言
主要特点就是高级语言与低级语言（汇编的混合编程）

***

## 2 汇编语言的基本结构
主要有三个，分别是：数据段、堆栈段、代码段



## 3.汇编语言的语法：

包括了

**指令**：可执行语句，之后会生成目标代码

**伪指令**：只是给编译器看，不产生目标代码

**宏指令**：源程序再汇编时要进行**宏展开**后才能够正常使用。

### 3.1汇编语言的语法及其格式：
（名称）（前缀）助记符（操作数）；注释

其中，

#### 名称 
可以是标号、变量名、段名、子过程名等等，由字母打头31个字符以内，**实际代表的是第一个存储单元的地址**，但是不能和系统的保留字冲突。
#### 前缀 
包括：`LOCK` 以及 `REP`
#### 指令助记符

### 3.2汇编语言的数据项

#### 常数
字母打头的必须在前面补0
如：0F56AH

其中还有字符串常数，是每个字符所对应的ASCII码值。
#### 字符串常数
被引号隔开，如`'AB'`，对应ASCll码，如‘123’对应的就是313233H

#### 标号
标号指的是存储某条指令的存储单元的符号化的地址。只能出现在代码段之中。常常配合（JMP\LOOP）等指令使用

作为存储单元的符号化地址，具有三种属性：
段地址
偏移地址
类型：NEAR和FAR


#### 变量
变量是数据段的第一个字节所对应的标识符号，常出现于数据段和堆栈段。


定义的方法：伪指令`DB`(DW、DQ、DQ、DT)
定义格式：变量名 DB **表达式**
主要的属性就是：段地址、偏移地址和类型（长度、大小）**变量的数据是存在存储器之中，所以存储器的规则在上面同样适用**
功能：从变量名地址开始的地方进行存储

所以，变量名在这里实质上对应了一个地址，而DB之内的没有赋予地址的功能，只有开辟空间的功能。

**两个变量直接相加不行**

**例**

1. 用问号作为表达式预留空间

		DATA7 DB ?

2. 带DUP的表达式

		DATA9 DB 3 DUP(00)
其中3为重复次数，00为重复内容

3. 用DW或者DB等赋值地址


		DATA11 DW DATA4
		DATA12 DD DATA4

若是DW，存储就是DATA4的偏移地址
若是DD则高位字还能表示段地址

注意：变量与标号没法相加，但是可以相减，其中，地址变量除外

### 表达式

表达式是由*操作符*和*运算符*符构成的，
这里的操作数可以是任何的形式（常量、变量、标号）**这里应该是不能是寄存器的，两者的概念是并行的，操作数更像是常数的衍生**

注：这里的表达式同之前的相同，但是实际上，表达式只有操作数也可。

#### 运算符

运算符有四类，它们分别是： **算数运算符、逻辑、关系、属性操作符**
这里的运算符区别之前的所说的助记符，这里的运算符一般只在数据段的表达式的中出现。

1. 算数运算符：+、-、*、/、MDO（取值）
2. 逻辑运算符：AND\OR\NOT\XOR(谨记，这里的逻辑运算符只能操作常数)
逻辑运算符只能按位进行，
3. 关系运算符：EQ LE LT GT LE GE 注意 这里的运算符只能对常数进行运算，参加运算的两个数是无符号数。结果就是1和0两个数值。
4. 属性操作符：包括 OFFSET\SEG\TYPE\LENGTH\SIZE


对于属性运算符，比如 OFFSET的作用就是得到偏移地址。

##### PTR

还有重新定义类型操作符`PTR`，用来对标号建立一个新的属性,**可以理解为是强制类型的转换**
常用的格式： 类型 PTR 变量/标号/地址表达式

- 对于变量，可以是，BYTE\WORD\DWORD类型
- 对于标号，可以是，NEAR\FAR类型

---
##### SEGMENT-ENDS

**定义方式**

段名 SEGMENT [定位类型][组合类型][类别]

段名 ENDS 

定位类型 PAGE\PARA\WORD\BYTE

组合类型 默认为 PRIVATE 
还有 PUBLIC\COMMON等

类别:'CLASS'
有点类似于CLASS，就是把不同模块的同一类型连接起来。

---
##### ASSUME
功能: 指明所定义的段与段寄存器的对应关系，并不是赋予地址值，必须在代码段,但是除了CS寄存器外，其他逻辑段的地址需要程序员自己装入寄存器中。

格式：ASSUME CS:CODE，DS：DATA

- DS\ES\SS的装入可以用赋值指令来完成,要有一个桥。
- CS\IP的初值由汇编来完成的
- 堆栈的赋值方式分两步
**首先**在定义的时候，就把他定义成STACK

**然后** 只需要用ASSUME对应SS就行了

---


##### 源程序结束伪指令END

END 标号（表达式）

---
#####赋值伪指令EQU

格式： 名称 EQU 表达式

一旦用了EQU，一个名称只能赋值一次，它的功能和“=”，相似但是后者却没有一次赋值性。


---


##### 定义名称类型伪指令 LABLE

格式： 名字 LABLE 类型

功能常在开辟空间中使用。就是一个得到当前的地址的指令，并把其赋值给标号。

---

##### 地址计数器伪指令

---

##### 定义结构体伪指令

说明：结构定义并不保留任何存储空间也不为任何存储单元赋值 ，它仅仅是一种模式。在引用结构和其它字段之前，须为结构分配空间或赋值





##### END
用END表示源程序的结束的位置

格式：
END 标号

这里的标号就是源程序开始的位置










---

#### 宏指令 

定义：用户自己定义的、用指令系统中的指令组成的新指令，先定义后调用，与使用其它系统指令一样方便


##### 宏定义
形式：

宏指令名 MACRO <形式参数>


ENDM

**说明**：

1. 宏指令本质上也是一种伪指令，是供汇编程序在代码生
成时遵从的一种约定。宏指令在形式上是由用户定义的一
组机器指令的封装。类比高级语言的函数的概念。

2. 形式参数可有可无，多个形参以‘,’分隔，参数个
数不限，但总字符数≤132，调用时将以实参代替。

##### 宏调用

宏指令名 实参





# 汇编语言设计（part 2）

## 1.汇编语言的程序的架构

需要分段储存它。
同时指令放在**代码段**，变量放在**数据段**

源程序执行过程包括以下四步：

![执行过程四步曲](https://github.com/jasonzhou123/coursenote-asm-XJTU/blob/master/chapter4/figures/1.png?raw=true)

## 2.程序的基本的结构：

程序的流程由结构决定。结构主要包括了：顺序结构、分支结构、循环结构、子程序结构。

### 2.1顺序结构

**特点**：没有循环、分支。

### 2.2分支程序的设计

**特点**：根据判断的条件进行转移，比如 `Jcc``JMP`

分支结构有，单分支，多分支之分。


单分支一般的配合：
测试/比较+Jcc

1. 多分支一般的配合：搭配无条件转移指令`JMP`
通常来讲，

	JMP的次数=分支数-1

2. 注意 1-2-1-3 结构,大开大合
3. 归为同一出口。

**例：跳转表**

主要思想：在段里面储存目标程序的地址。


分支程序的设计与保存。

### 2.3循环程序

通常由三个部分组成：

- 循环的初始化

- 循环体

- 循环控制


循环的基本结构 WHILE-DO\DO UNTIL

常用的指令： LOOP和 JCXZ

**例：数组求和**

记住画流程图。

**例：冒泡排序法**


注意需要两层循环

其中，外循环需要把内循环嵌套在里面的循环里面。


**例：求最大数以及最小数**


### 2.4子程序的设计

子程序是一个独立的程序段，具有确定的功能，可以被其他的程序调用，调用它的程序一般为主程序。

子程序的调用与返回

主程序调用子程序通过CALL指令来实现，用`RET`来返回调用。

子过程的定义与调用

定义过程的伪指令`PROC-RET-ENDP`成对出现使用。


**子程序寄存器内容的保护和恢复，但是对于一些用传递参数的寄存器不能去保护它。**

**参数的传递方式**

1. 寄存器传送的方式。
2. 在数据段的变量里面。
3. 把参数放在地址表里。
4. 压入堆栈之中。

入口参数与出口参数。
在数据段之中已经处理好了。

**例：4为十六进制ASCII转化为二进制数字**

参数传递的方法：

堆栈的参数传递方式：由主程序执行，用`BP`进行操作而不是用`SP`，相当于`SP`作为堆栈顶是移动和自变的，而`BP`则是一个可以传递堆栈指针的专用寄存器。

### 2.5 多模块设计的方法

LINK程序再在进行多模块程序链接的时候，依赖SEGMENT语句提供的组合类型进行连接。

交叉访问的标识符：

1. PUBLIC 伪指令
2. EXTRN 伪指令


## 汇编语言 PART 3

### 1. 汇编程序以及上机过程

编辑，汇编，连接，调试运行

批处理文件 .bat

语法 mm

### 2.汇编程序的操作

**两次扫描**

第一次扫描 建立符号表

第二次扫描 根据伪指令以及符号表，产生机器码。

### 3.DOS以及BIOS

所谓的`DOS功能及其调用其实就是设计者写好的子程序`
DOS 提供与外部交互的方法

而调用它的方式就是通过**软中断的方式**实现的。

高层次的普通用户 - 键入命令

较低层次的高级用户 -  软中断方式进行控制，调用DOS

功能子程序，常驻在内存中，或者固化在ROM中



软件的中断可以分为三部分：

DOS中断、ROM BIOS中断、自由中断

中断矢量表：保存中断程序的入口过程。系统调用的子功能。入口参数。

寄存器中取出相关的功能，常用的中断具有两大类。 
DOS的专用的中断、DOS可调用的中断。

INT 21H 系统功能调用

把下列的字符传入AH中，然后再进行调用。

01H - 输入字符

02H - 输入字符串


BIOS的功能调用类似

### 高级语言与汇编语言的混合编程

- 程序控制
- 参数传递：一般采用堆栈传递